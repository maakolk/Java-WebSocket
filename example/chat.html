<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Chat Client</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="prototype.js"></script>
    <script type="text/javascript">
        document.observe("dom:loaded", function() {
            function log(text) {
                $("log").innerHTML = (new Date).getTime() + ": " + (!Object.isUndefined(text) && text !== null ? text.escapeHTML() : "null") + $("log").innerHTML;
            }

            if (!window.WebSocket) {
                var head = $$("head")[0];
                head.insert(new Element("script", { type: "text/javascript", src: "swfobject.js" }));
                head.insert(new Element("script", { type: "text/javascript", src: "FABridge.js" }));
                head.insert(new Element("script", { type: "text/javascript", src: "web_socket.js" }));
                log("WebSocket not natively supported, falling back to Flash");
            } else {
                log("Using browser's native WebSocket implementation")
            }

            var ws;

            function connect() {
                ws = new WebSocket($F("uri"));
                ws.onopen = function() {
                    log("[WebSocket#onopen] called.\n");
                    $("uriForm").enable();
                }
                ws.onmessage = function(e) {
                    log("[WebSocket#onmessage] called.\n\tMessage: " + e.data + "\n");
                }
                ws.onclose = function() {
                    log("[WebSocket#onclose] called.\n");
                    $("uriForm").disable();
                    ws = null;
                }
            }

            function send() {
                if (ws) {
                    var textField = $("textField");
                    ws.send(textField.value);
                    log("[WebSocket#send] called.\n\tSent string: " + textField.value + "\n");
                    textField.value = "";
                    textField.focus();
                }
            }

            $("uriForm").observe("submit", function(e) {
                e.stop();
                connect();
            });

            $("sendForm").observe("submit", function(e) {
                e.stop();
                send();
            });

            $("disconnect").observe("click", function() {
                if (ws) {
                    ws.close();
                }
            });
        });
    </script>
  </head>
  <body>
      <form id="uriForm"><input type="text" id="uri" value="ws://localhost" style="width:200px;"> <input type="submit" value="Connect"><input type="button" id="disconnect" value="Disconnect"></form><br>
      <form id="sendForm"><input type="text" id="textField" value="" style="width:200px;"> <input type="submit" value="Send"></form><br>
      <textarea id="log" rows="50" cols="100"></textarea><br>
  </body>
</html>
